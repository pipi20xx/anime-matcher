# ANIMEProMatcher Kernel

é«˜æ€§èƒ½åŠ¨æ¼«æ–‡ä»¶åè¯†åˆ«ä¸å…ƒæ•°æ®è”åŠ¨æ ¸å¿ƒ (Layer 1 + 2 + 3)ã€‚é‡‡ç”¨å…¨è§£è€¦å¾®æœåŠ¡æ¶æ„ï¼Œæä¾›ä»â€œåŸå§‹æ–‡ä»¶åâ€åˆ°â€œæ ‡å‡†åŒ–å…ƒæ•°æ®â€çš„ä¸€ç«™å¼è§£ææ–¹æ¡ˆã€‚

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

- **ä¸‰å±‚æ¶æ„è®¾è®¡**:
  - **Layer 1 (Core)**: åŸºäºå†…ç½®æ·±åº¦å®šåˆ¶ anitopy çš„è¯­ä¹‰è§£æå†…æ ¸ã€‚
  - **Layer 2 (Cloud)**: é›†æˆ TMDB & Bangumi æ™ºèƒ½å¯¹æ’ä¸è‡ªåŠ¨æ˜ å°„ç®—æ³•ã€‚
  - **Layer 3 (Render)**: å†…ç½®ä¸“å®¶çº§æ¸²æŸ“å¼•æ“ï¼Œæ”¯æŒå¤æ‚çš„é›†æ•°åç§»è®¡ç®— (@formula) ä¸æ ‡é¢˜ç¿»è¯‘ã€‚
- **å…¨é‡å®¡è®¡æ—¥å¿—**: ç‹¬åˆ› 9 æ­¥æ·±åº¦å®¡è®¡æµï¼Œå®Œæ•´å›æº¯è§£æã€åŒ¹é…ã€å¯¹æ’ã€æ¸²æŸ“çš„æ¯ä¸€ä¸ªåˆ¤å†³ç»†èŠ‚ã€‚
- **å®Œå…¨è§£è€¦**: é›¶é…ç½®å¯åŠ¨ï¼Œæ”¯æŒ Docker å®¹å™¨åŒ–ï¼Œä¸ä¾èµ–å¤–éƒ¨æ•°æ®åº“ã€‚

## ğŸ“– API è¯·æ±‚è§„èŒƒ (POST `/recognize`)

### å®Œæ•´è¯·æ±‚ç¤ºä¾‹ (JSON Body)

```json
{
  "filename": "[ANi] èŠ±æ¨£å°‘å¹´å°‘å¥³ - 02.mkv",
  "custom_words": [],
  "custom_groups": [],
  "custom_render": [],
  "force_filename": false,
  "batch_enhancement": false,
  "with_cloud": false,
  "anime_priority": true,
  "bangumi_priority": false,
  "tmdb_api_key": "string",
  "tmdb_proxy": "string",
  "bangumi_token": "string",
  "bangumi_proxy": "string"
}
```

### è¯·æ±‚å‚æ•°è¯¦ç»†è¯´æ˜

| å­—æ®µå | é»˜è®¤å€¼ | ç±»å‹ | åŠŸèƒ½æè¿° |
| :--- | :--- | :--- | :--- |
| **filename** | (å¿…å¡«) | string | å¾…è¯†åˆ«çš„æ–‡ä»¶åæˆ–å®Œæ•´æ–‡ä»¶è·¯å¾„ |
| **custom_words** | `[]` | list | L1 é¢„å¤„ç†è§„åˆ™ (A => B)ï¼Œåœ¨è§£æå‰æ‰§è¡Œ |
| **custom_groups** | `[]` | list | è‡ªå®šä¹‰åˆ¶ä½œç»„åå•ï¼Œè¾…åŠ©å†…æ ¸é”å®šå°ç»„å­—æ®µ |
| **custom_render** | `[]` | list | **L3 ä¸“å®¶æ¸²æŸ“è§„åˆ™**: æ”¯æŒæ¡ä»¶ä¿®æ”¹ä¸åç§»è®¡ç®— |
| **force_filename**| `false` | bool | å¼ºåˆ¶å•æ–‡ä»¶æ¨¡å¼ï¼Œå±è”½è·¯å¾„å¹²æ‰°è¯ |
| **batch_enhancement** | `false`| bool | å¼€å¯åˆé›†/æ‰¹å¤„ç†å¢å¼ºé€»è¾‘ |
| **with_cloud** | `false` | bool | **äº‘ç«¯è”åŠ¨æ€»å¼€å…³**ï¼Œå¼€å¯åæ‰§è¡Œç½‘ç»œåŒ¹é… |
| **anime_priority**| `true` | bool | è”ç½‘åŒ¹é…æ—¶å¼€å¯åŠ¨ç”»åˆ†ç±»åŠ æƒä¼˜åŒ– |
| **bangumi_priority**| `false` | bool | ä¼˜å…ˆæ£€ç´¢ Bangumi åº“å¹¶æ˜ å°„è‡³ TMDB |
| **tmdb_api_key** | `null` | string | TMDB å¯†é’¥ (ä¹Ÿå¯é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®) |
| **tmdb_proxy** | `null` | string | æŒ‡å®š TMDB ç½‘ç»œè¯·æ±‚ä»£ç† |
| **tmdb_id** | `null` | string | **å·²çŸ¥ ID æç¤º**: ä¼ å…¥åå¯ç›´æ¥è§¦å‘ä¸“å®¶è§„åˆ™ï¼Œè·³è¿‡äº‘ç«¯æ£€ç´¢ |
| **tmdb_type** | `null` | string | **å·²çŸ¥ç±»å‹æç¤º**: å–å€¼ `movie` æˆ– `tv`ï¼Œé…åˆ `tmdb_id` ä½¿ç”¨ä»¥æ¶ˆé™¤æ­§ä¹‰ |
| **bangumi_token** | `null` | string | Bangumi ä¸ªäººæˆæƒä»¤ç‰Œ (å¯é€‰) |
| **bangumi_proxy** | `null` | string | æŒ‡å®š Bangumi ç½‘ç»œè¯·æ±‚ä»£ç† |

---

## ğŸ“– è¿”å›ç»“æœå…¨å­—æ®µè¯´æ˜

### 1. `local_result` (æœ¬åœ°è§£æåŸå§‹ç»“è®º)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| `cn_name` | string | æå–åˆ°çš„ä¸­æ–‡å‰§åæœç´¢å— |
| `en_name` | string | æå–åˆ°çš„è‹±æ–‡/ç‰¹å¾æœç´¢å— |
| `team` | string | è¯†åˆ«åˆ°çš„åˆ¶ä½œç»„/å­—å¹•ç»„ |
| `season` | int | è¯†åˆ«åˆ°çš„å­£åº¦ç¼–å· |
| `episode` | int | è¯†åˆ«åˆ°çš„é›†æ•°ç¼–å· |
| `is_batch` | bool | æ˜¯å¦åˆ¤å®šä¸ºåˆé›†/æ‰¹å¤„ç† |
| `end_episode` | int | åˆé›†æ—¶çš„ç»“æŸé›†æ•° |
| `type` | string | åª’ä½“ç±»å‹ (`tv` / `movie`) |
| `resolution` | string | åˆ†è¾¨ç‡è§„æ ¼ |
| `platform` | string | å‘å¸ƒå¹³å° |
| `source` | string | èµ„æºæ¥æº |
| `video_encode` | string | è§†é¢‘ç¼–ç æ ¼å¼ |
| `audio_encode` | string | éŸ³é¢‘ç¼–ç æ ¼å¼ |
| `subtitle` | string | è¯†åˆ«åˆ°çš„å­—å¹•è¯­è¨€ |
| `year` | string | è¯†åˆ«åˆ°çš„å‘å¸ƒå¹´ä»½ |

### 2. `final_result` (å…¨ä¿¡æ‰˜æœ€ç»ˆç»“è®º - ä¸ä¸»é¡¹ç›®å¯¹é½)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
| :--- | :--- | :--- |
| **`title`** | string | **æœ€ç»ˆé‡‡ä¿¡æ ‡é¢˜** (ä¼˜å…ˆä½¿ç”¨äº‘ç«¯/ä¸“å®¶è§„åˆ™ä¿®æ­£) |
| **`tmdb_id`** | string | **TMDB å”¯ä¸€è¯†åˆ«ç ** |
| `category` | string | åª’ä½“åˆ†ç±» (`å‰§é›†` / `ç”µå½±`) |
| `processed_name`| string | **æ¸²æŸ“åæ ‡é¢˜**: æŒ‰ç…§ä¸“å®¶è§„åˆ™é‡å‘½ååçš„æ–‡ä»¶å |
| `poster_path` | string | äº‘ç«¯æµ·æŠ¥å›¾ç‰‡è·¯å¾„ |
| `release_date` | string | æ­£å¼ä¸Šæ˜ æ—¥æœŸ |
| `season` | int | æœ€ç»ˆå†³å®šçš„å­£åº¦ |
| `episode` | string | æœ€ç»ˆå†³å®šçš„é›†æ•°æˆ–èŒƒå›´ (å¦‚ `13` æˆ– `01-12`) |
| `team` | string | æœ€ç»ˆç¡®å®šçš„åˆ¶ä½œå°ç»„ |
| `resolution` | string | æœ€ç»ˆåˆ†è¾¨ç‡ |
| `video_encode` | string | æœ€ç»ˆè§†é¢‘ç¼–ç  |
| `video_effect` | string | è§†é¢‘ç‰¹æ•ˆ (å¦‚ `HDR`, `Dolby Vision`) |
| `audio_encode` | string | æœ€ç»ˆéŸ³é¢‘ç¼–ç  |
| `subtitle` | string | æœ€ç»ˆå­—å¹•è¯­è¨€ |
| `source` | string | æœ€ç»ˆèµ„æºæ¥æº |
| `platform` | string | æœ€ç»ˆå‘å¸ƒå¹³å° |
| `origin_country` | string | **åˆ¶ç‰‡å›½å®¶** (å¦‚ `æ—¥æœ¬`, `ç¾å›½`) |
| `vote_average` | float | åª’ä½“è¯„åˆ† |
| `year` | string | æœ€ç»ˆå¹´ä»½ |
| `duration` | string | è¯†åˆ«è€—æ—¶ |
| `filename` | string | åŸå§‹æ–‡ä»¶å |
| `path` | string | åŸå§‹å®Œæ•´è·¯å¾„ |

## ğŸ“¦ å¿«é€Ÿå¯åŠ¨

```bash
cd anime-matcher && docker-compose up -d
```
è®¿é—® `http://localhost:8081/docs` æŸ¥çœ‹ Swagger äº¤äº’å¼æ–‡æ¡£ã€‚

---

## ğŸ“– è§„åˆ™ç¼–å†™æŒ‡å— (Rules Guide)

ä¸ºäº†å®ç°ç²¾å‡†çš„è¯†åˆ«ä¸ä¸ªæ€§åŒ–çš„é‡å‘½åï¼Œæœ¬é¡¹ç›®æ”¯æŒä¸¤å¥—å¼ºå¤§çš„è§„åˆ™ç³»ç»Ÿï¼š

- [**è‡ªå®šä¹‰è¯†åˆ«è¯ (é¢„å¤„ç†)**](./docs/recognition-rules.md): ä½œç”¨äºâ€œæ–‡ä»¶åâ€è§£æå‰ã€‚ç”¨äºå±è”½å¹²æ‰°å­—ç¬¦ã€çº æ­£æ ‡é¢˜è¯¯åŒ¹é…ã€æˆ–å¼ºåˆ¶é”å®šç‰¹å®š TMDB IDã€‚
- [**è‡ªå®šä¹‰æ¸²æŸ“è¯ (åå¤„ç†)**](./docs/render-rules.md): ä½œç”¨äºâ€œåŒ¹é…ç»“è®ºâ€ç”Ÿæˆåã€‚æ”¯æŒä¸“å®¶çº§çš„æ¡ä»¶ä¿®æ­£ï¼ˆåŸºäº ID/å­£/é›†ï¼‰ã€é›†æ•°åç§»è®¡ç®—ã€è‡ªåŠ¨æ‰“æ ‡ç­¾ç­‰ã€‚
