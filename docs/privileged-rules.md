# 自定义特权规则 (Privileged Rules)

**核心处理文件**: `backend/recognition_engine/special_episode_handler.py`

特权规则是**优先级最高**的提取规则，在识别流程的最早期执行。命中后：
- **集数直接锁定**，不会被后续流程覆盖
- **标题作为优先搜索候选**，提高匹配准确率

---

## 🎯 规则格式

```
正则表达式|||字幕组索引|||标题索引|||集数索引|||描述
```

使用 `|||` 分隔五个部分：

| 部分 | 说明 | 必填 |
| :--- | :--- | :--- |
| **正则表达式** | 用于匹配文件名的正则模式 | ✅ |
| **字幕组索引** | 正则捕获组索引，提取字幕组名称 | ❌ (可填 `无` 或留空) |
| **标题索引** | 正则捕获组索引，提取标题 | ✅ |
| **集数索引** | 正则捕获组索引，提取集数 | ✅ |
| **描述** | 规则描述，用于日志显示 | ✅ |

---

## 📝 常用规则模板

### 1. 标准格式 `[字幕组] 标题 - 集数`

**文件名示例：**
```
[LoliHouse] Goumon Baito-kun no Nichijou - 08 [WebRip 1080p].mkv
[MILKs&LoliHouse] Saioshi no Gikei - 12 [WebRip 1080p].mkv
```

**规则：**
```
^\[([^\]]+)\]\s+(.+?)\s+-\s+(\d{1,4})(?:\s|\[|$)|||1|||2|||3|||通用格式 [Group] Title - EP
```

**解析：**
| 正则部分 | 说明 |
| :--- | :--- |
| `^\[([^\]]+)\]` | 匹配开头的 `[字幕组]`，捕获组 1 |
| `\s+` | 匹配空格 |
| `(.+?)` | 非贪婪匹配标题，捕获组 2 |
| `\s+-\s+` | 匹配 ` - ` |
| `(\d{1,4})` | 匹配 1-4 位集数，捕获组 3 |
| `(?:\s|\[|$)` | 匹配空格、`[` 或结尾 |

---

### 2. 括号集数格式 `[字幕组] 标题 [集数]`

**文件名示例：**
```
[SweetSub] Mononoke - The Ashes of Rage [05][BDRip].mp4
```

**规则：**
```
^\[([^\]]+)\]\s+(.+?)\s+\[(\d{1,4})\]|||1|||2|||3|||括号格式 [Group] Title [EP]
```

---

### 3. 指定字幕组定向规则

**文件名示例：**
```
[LoliHouse] Title - 01 [WebRip].mkv
```

**规则：**
```
^\[(LoliHouse)\]\s+(.+?)\s+-\s+(\d{1,4})|||1|||2|||3|||LoliHouse 定向
```

---

### 4. 合作字幕组规则

**文件名示例：**
```
[NC-Raws & LoliHouse] Title - 01 [WebRip].mkv
```

**规则：**
```
^\[(.*?LoliHouse.*?)\]\s+(.+?)\s+-\s+(\d{1,4})|||1|||2|||3|||LoliHouse 合作组
```

---

### 5. 无字幕组格式 `标题 - 集数`

**文件名示例：**
```
Title Name Here - 08 [1080p].mkv
```

**规则：**
```
^([^\[\]]+?)\s+-\s+(\d{1,4})(?:\s|\[|$)|||无|||1|||2|||无组格式 Title - EP
```

---

### 6. 带副标题格式 `[字幕组] 标题 [集数_副标题]`

**文件名示例：**
```
[晚街与灯] Title [05_大海啸].mkv
```

**规则：**
```
\[(晚街[與与]燈)\]\s*(.+?)\s*\[(\d{1,3})(?:\s*[-_][^\]]*)?\]|||1|||2|||3|||晚街与灯 定向
```

---

## 🔧 正则编写指南

### 捕获组索引说明

正则中用 `()` 包围的部分是捕获组，索引从 1 开始：

```
^\[([^\]]+)\]\s+(.+?)\s+-\s+(\d{1,4})
   ↓        ↓          ↓
  组(1)    组(2)      组(3)
  字幕组    标题       集数
```

### 常用正则模式

| 模式 | 说明 | 示例 |
| :--- | :--- | :--- |
| `\[` | 匹配 `[` (需转义) | `^\[` 匹配开头 `[` |
| `\]` | 匹配 `]` (需转义) | `[^\]]+` 匹配非 `]` 字符 |
| `\s+` | 匹配一个或多个空格 | `\s+-\s+` 匹配 ` - ` |
| `\d{1,4}` | 匹配 1-4 位数字 | 集数提取 |
| `(.+?)` | 非贪婪匹配任意字符 | 标题提取 |
| `[^\]]+` | 匹配非 `]` 的任意字符 | 字幕组提取 |
| `(?:\s|\[|$)` | 非捕获组，匹配空格/`[`/结尾 | 结束边界 |
| `(?:v\d)?` | 可选的版本号 | 匹配 `v2` 等 |

### 边界匹配技巧

| 需求 | 写法 |
| :--- | :--- |
| 匹配开头 | `^` |
| 匹配结尾 | `$` |
| 集数后是空格或 `[` | `(?:\s|\[|$)` |
| 可选版本号 `v2` | `(?:v\d)?` |

---

## 📋 完整示例

### 输入规则

```
^\[([^\]]+)\]\s+(.+?)\s+-\s+(\d{1,4})(?:\s|\[|$)|||1|||2|||3|||通用格式 [Group] Title - EP
^\[([^\]]+)\]\s+(.+?)\s+\[(\d{1,4})\]|||1|||2|||3|||括号格式 [Group] Title [EP]
^\[(LoliHouse)\]\s+(.+?)\s+-\s+(\d{1,4})|||1|||2|||3|||LoliHouse 定向
```

### 匹配效果

| 文件名 | 命中规则 | 字幕组 | 标题 | 集数 |
| :--- | :--- | :--- | :--- | :--- |
| `[LoliHouse] Title - 08 [1080p].mkv` | LoliHouse 定向 | LoliHouse | Title | 8 |
| `[SweetSub] Name [05].mp4` | 括号格式 | SweetSub | Name | 5 |
| `[MyGroup] Anime - 12.mkv` | 通用格式 | MyGroup | Anime | 12 |

---

## ⚠️ 注意事项

### 1. 规则优先级

规则按**从上到下**的顺序匹配，第一条命中的规则生效。建议：
- 特定字幕组规则放在前面
- 通用规则放在后面

### 2. 标题验证

提取的标题必须满足：
- 长度 ≥ 2 个字符
- 不能为空

### 3. 集数锁定

特权提取的集数**不可被覆盖**，后续流程（Anitopy、合集增强等）都会跳过集数处理。

### 4. 多语言标题

如果标题包含 `/`（如 `中文标题 / English Title`），系统会自动拆分为多个搜索词依次搜索。

---

## 🚀 使用方式

### 方式一：前端配置

在 **系统设置 → 识别与订阅规则 → 自定义特权规则** 中输入规则。

### 方式二：远程 URL

创建纯文本文件托管在服务器：

```
# 这是注释，会被忽略
^\[([^\]]+)\]\s+(.+?)\s+-\s+(\d{1,4})(?:\s|\[|$)|||1|||2|||3|||通用格式
^\[(LoliHouse)\]\s+(.+?)\s+-\s+(\d{1,4})|||1|||2|||3|||LoliHouse 定向
```

然后在 **远程 URL** 中填入文件地址，点击同步即可。
