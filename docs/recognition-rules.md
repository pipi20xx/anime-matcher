# 自定义识别词 (Custom Rules)

**核心处理文件**: `src/anime_matcher/title_cleaner.py` (逻辑位于 `pre_clean` 函数)

此环节拥有双重功能：既可以作为 **“橡皮擦”** 清除无效词汇（屏蔽），也可以作为 **“记号笔”** 提前强制标记正确的 ID 或季数（提取）。

---

## 🎯 实战演练 (Case Study)

假设文件名为：
`[SumiSora][Fate Stay Night Unlimited Blade Works][25v2][BDrip][1080p][HEVC_FLAC].mkv`

以下展示 6 种不同维度的规则写法及其效果：

| 模式 | 写法 (规则) | 效果 / 解释 |
| :--- | :--- | :--- |
| **1. 简单屏蔽 (Block)** | `SumiSora` | **删除** "SumiSora"。<br>本质是 `SumiSora =>` (替换为空) 的简写。 |
| **2. 简单替换 (Replace)** | `Unlimited Blade Works => UBW` | 将长标题缩写为 **"UBW"**，利于后续搜索。 |
| **3. 正则提取元数据 (Regex Meta)** | `Fate Stay Night => {[tmdbid=60553]}` | 识别到该词时，直接 **强制锁定 TMDB ID**，跳过云端搜索。 |
| **4. 定位器偏移 (Locator Offset)** | `[ <> v2] >> +100` | 定位 `[` 和 `v2]` 之间的数字 (25)，执行 +100。<br>结果：**125** |
| **5. 捕获组计算 (Group Formula)** | `\[(\d+)v2\] => {[e=\1@*2+1]}` | 捕获数字 (25)，代入公式 `25 * 2 + 1`。<br>结果：强制集数为 **E51** |
| **6. 组合规则 (Combined)** | `SumiSora && Unlimited Blade Works => UBW` | 从左到右依次执行：先删除 `SumiSora`，再将 UBW 替换。 |

---

## 🛠️ 强制提取字段详解 (Metadata Tags)

在替换目标中使用 `{[key=value]}` 语法，可跳过后续识别逻辑，直接锁定属性。

| 字段 | 说明 | 示例 |
| :--- | :--- | :--- |
| **`tmdbid`** | **(最常用)** 强制指定 TMDB ID，跳过搜索，直接精准匹配。 | `{[tmdbid=80000]}` |
| **`type`** | 强制指定资源类型。仅支持 `tv` 或 `movie`。 | `{[type=movie]}` (强制识别为电影) |
| **`s`** | 强制指定季度 (Season)。 | `{[s=1]}` |
| **`e`** | 强制指定集数 (Episode)。支持公式计算。 | `{[e=12]}` 或 `{[e=\1@+1]}` |

---

## ⚡ 正则与语法提示 (Regex Guide)

系统基于 **Python `re` 模块** 实现，支持标准正则表达式。

### 1. 核心语法特性
*   **忽略大小写**: 系统默认开启了 `re.I` (Ignore Case) 标志，因此 `hevc` 也能匹配 `HEVC`。
*   **边界匹配**: `\bWord\b` (全词匹配，防止误伤 `Word2`)
*   **模糊匹配**: `Word.*Test` (匹配中间任意字符)
*   **位置锚点**: `^Start` (仅匹配开头), `End$` (仅匹配结尾)
*   **字符集**: `[a-z]` (字母), `\d+` (数字)

### 2. 规则类型本质
*   **简单替换 (A => B)**: 左边是正则，右边是普通字符串（支持 `\1` 引用捕获组）。
    *   示例: `Part\s*(\d+) => Pt.\1` (将 "Part 01" 替换为 "Pt.01")
*   **简单屏蔽**: 本质上就是 `正则 => 空字符串` 的简写。
    *   示例: `\d+bit` (屏蔽 "10bit", "8bit" 等)
