# 自定义渲染词 (Custom Render)

作用阶段：识别匹配完成后 **后处理**。
核心处理脚本：`src/anime_matcher/render_engine.py`

> **核心区别**：
> *   **识别词**: 作用于“文件名”，影响**识别准确率**。
> *   **渲染词**: 作用于“最终元数据”，影响 **UI展示标题** 和 **生成的标签**。

---

## 1. 正则翻译/替换 (Regex Replacement)
**语法**: `Regex => Replacement`

完全支持 Python 标准正则语法（默认开启 `re.I` 忽略大小写）。如果替换结果不为空，系统会自动将其作为一个 **标签 (Tag)** 添加到卡片上。

*   **规则**: `Unlimited Blade Works => UBW`
    *   **预期效果**: 最终识别结果的标题中的 "Unlimited Blade Works" 会变成 "UBW"，并且卡片上会多一个 `UBW` 的标签。
*   **规则**: `(\d{4})p => \1P`
    *   **预期效果**: "1080p" -> "1080P"，并增加 `1080P` 标签。

---

## 2. 元数据提取 (Regex Extraction)
**语法**: `Regex => {[key=value]}`

如果核心识别步骤有误，可在此最后关头进行强制覆盖。

*   **规则**: `25v2 => {[e=25]}`
    *   **预期效果**: 再次强制确认：“只要看到 25v2，集数就是 25”。

---

## 3. 偏移定位器 (Offset Locator)
**语法**: `前词 <> 后词 >> 公式`

针对特定片段进行定位和数值计算。

*   **规则**: `[ <> v2] >> EP+10`
    *   **预期效果**: 针对 `[25v2]` 这一段，系统定位到数字 25，执行 +10。最终集数变为 **35**。

---

## 4. 🚀 专家级条件修正 (Expert Conditional)
**语法**: `@?{[条件列表]} => {[动作列表]}`

这是最强大的模式，支持基于多维度条件（文件名、ID、年份、集数范围）触发复杂的元数据重写。

### 经典实战场景

#### A. 替换剧集年份 (支持增加季判断)
*   **规则**: `@?{[tmdbid=258055;type=tv]} => {[year=2099]}`
*   **含义**: 当源 TMDB ID 为 258055 且类型为 tv 时，目标年份设置为 2099。
*   **提示**: 可在源部分增加 `s=季号` 来进一步限定条件。

#### B. 集数范围判断为特定季，并调整集编号
*   **规则**: `@?{[tmdbid=127532;type=tv;e=13-25]} => {[s=2;e=EP-12]}`
*   **含义**: 剧集 ID 127532，当集数在 13 到 25 之间时，目标季设为 2，集编号改为 `EP-12` (即原集号减12)。
*   **场景**: 完美处理“连播番”问题（如 13-24 话实为第二季）。

#### C. 大范围集数判断为特定季
*   **规则**: `@?{[tmdbid=37854;type=tv;e=523-580]} => {[s=14]}`
*   **含义**: 当海贼王等长篇连载集数在 523 到 580 之间时，目标季强制设为 14。

#### D. 基于字幕组的季度修正
*   **规则**: `@?{[includes=SumiSora; e=25]} => {[s=5]}`
*   **含义**: 文件名包含 `SumiSora` 且 当前集数是 25 时，强制改为 S5。

---

### 模式 B: 模糊包含匹配 (includes)
这是专家规则中唯一直接作用于 **原始文件名/清洗后文件名** 的条件。它不看识别出的 ID 或季度，而是像搜索引擎一样在文件名里找关键字。

> **⚠️ 技术原理**: `includes` 仅支持 **普通关键词 (Substring)** 匹配，**不支持正则**。
> 但它支持高级逻辑运算符来实现复杂组合。

#### 操作符支持
| 操作符 | 含义 | 说明 |
| :--- | :--- | :--- |
| `&` | **逻辑且 (AND)** | 所有条件必须同时满足。 |
| `|` | **逻辑或 (OR)** | 任一条件满足即可 (代码兼容 `||` 写法)。 |
| `()` | **分组** | 用于控制运算优先级。 |

#### 实战演练
1.  **简单包含匹配**:
    *   规则: `@?{[includes=WEB]} => {[s=1;e=+0]}`
    *   含义: 只要包含 "WEB"，就命中。

2.  **或操作 (|)**:
    *   规则: `@?{[includes=WEB|WEBRip|WEBDL]} => {[s=1;e=EP+0]}`
    *   含义: 只要包含 "WEB" 或 "WEBRip" 或 "WEBDL" 中任意一个，就算命中。

3.  **与操作 (&)**:
    *   规则: `@?{[includes=WEB&1080p]} => {[s=1;e=EP+0]}`
    *   含义: 必须同时包含 "WEB" 和 "1080p" 两个关键词，才算命中。

4.  **复杂表达式 (括号和组合)**:
    *   规则: `@?{[includes=(Netflix&1080p)|(Amazon&4K)]} => {[s=2;e=EP+0]}`
    *   含义: 满足 (Netflix 且 1080p) 或者 (Amazon 且 4K) 任一组合即命中。

---

## 🛠️ 专家规则支持的字段详解

专家规则右边（动作部分 `{[Action]}`）专门用于修正 **"我是谁"** (ID/季/集)，而不是 **"我长啥样"** (画质/组)。

### 1. 核心元数据 (Core)
*   **`tmdbid`**: **(重定向)** 一旦指定，系统会立即丢弃当前结果，用此 ID 重新去 TMDB 拉取所有信息。
*   **`type`**: 修改类型 (`tv` 或 `movie`)。

### 2. 剧集与定位 (Episode & Season)
*   **`s`**: 修改季度号。
*   **`e`**: 修改集数。**支持公式** (必须使用 `EP` 变量)。
    *   示例: `{[e=EP-12]}` 或 `{[e=0]}` (剧场版)。
*   **`year`**: 修改年份。

### ⚠️ 特别注意
像 `resolution` (分辨率), `team` (制作组) 等属性，在专家规则的右边 **不支持直接修改**。请使用 **第一类：正则替换规则** 来实现对标题文字的修改和打标签。
